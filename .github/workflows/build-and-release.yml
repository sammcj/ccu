name: Build and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# cancel in progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  security-events: read

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, '[skip-ci]')
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
      changelog: ${{ steps.tag_version.outputs.changelog }}
    permissions:
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@a22cf08638b34d5badda920f9daf6e72c477b07b # v6.2
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: main
          default_bump: patch
          tag_prefix: v
          create_annotated_tag: true
          fetch_all_tags: true
          skip_on_missing_release_branches: true

  build-linux-amd64:
    name: Build Linux AMD64
    runs-on: ubuntu-latest
    needs: [bump-version]
    if: always() && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped') && !contains(github.event.head_commit.message, '[skip-ci]')
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Extract Go version from go.mod
        id: go-version
        run: echo "version=$(grep '^go ' go.mod | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ steps.go-version.outputs.version }}
          check-latest: true

      - name: Set up Go cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-amd64-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-amd64-go-

      - name: Get dependencies
        run: go mod download

      - name: Test
        run: make test

      - name: Build
        env:
          GOOS: linux
          GOARCH: amd64
        run: |
          # Get version from tag, bump-version job, or use SHA for non-tag builds
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            # If this is a tag build, use the tag version
            VERSION=${GITHUB_REF#refs/tags/v}
          elif [[ "${{ github.ref }}" == "refs/heads/main" && "${{ needs.bump-version.outputs.new_tag }}" != "" ]]; then
            # If this is a main branch build with a new tag from bump-version job
            VERSION="${{ needs.bump-version.outputs.new_tag }}"
            VERSION=${VERSION#v}  # Remove the 'v' prefix
          else
            # For PR builds, use the commit SHA
            VERSION="sha-$(git rev-parse --short HEAD)"
          fi

          echo "Building version: $VERSION for linux/amd64"

          # Get commit hash
          COMMIT=$(git rev-parse --short HEAD)

          # Get build date
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Create output directory
          mkdir -p bin

          # Build with ldflags to inject version info
          go build -v -o "bin/ccu-linux-amd64" \
            -ldflags "-s -w -X main.Version=$VERSION -X main.Commit=$COMMIT -X main.BuildDate=$BUILD_DATE" \
            ./cmd/ccu

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ccu-linux-amd64
          path: bin/ccu-linux-amd64
          retention-days: 7

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-latest
    needs: [bump-version]
    if: always() && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped') && github.event_name != 'pull_request' && !contains(github.event.head_commit.message, '[skip-ci]')
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Extract Go version from go.mod
        id: go-version
        run: echo "version=$(grep '^go ' go.mod | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ steps.go-version.outputs.version }}
          check-latest: true

      - name: Set up Go cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-arm64-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-arm64-go-

      - name: Get dependencies
        run: go mod download

      - name: Build
        env:
          GOOS: linux
          GOARCH: arm64
        run: |
          # Get version from tag, bump-version job, or use SHA for non-tag builds
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            # If this is a tag build, use the tag version
            VERSION=${GITHUB_REF#refs/tags/v}
          elif [[ "${{ github.ref }}" == "refs/heads/main" && "${{ needs.bump-version.outputs.new_tag }}" != "" ]]; then
            # If this is a main branch build with a new tag from bump-version job
            VERSION="${{ needs.bump-version.outputs.new_tag }}"
            VERSION=${VERSION#v}  # Remove the 'v' prefix
          else
            # For PR builds, use the commit SHA
            VERSION="sha-$(git rev-parse --short HEAD)"
          fi

          echo "Building version: $VERSION for linux/arm64"

          # Get commit hash
          COMMIT=$(git rev-parse --short HEAD)

          # Get build date
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Create output directory
          mkdir -p bin

          # Build with ldflags to inject version info
          go build -v -o "bin/ccu-linux-arm64" \
            -ldflags "-s -w -X main.Version=$VERSION -X main.Commit=$COMMIT -X main.BuildDate=$BUILD_DATE" \
            ./cmd/ccu

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ccu-linux-arm64
          path: bin/ccu-linux-arm64
          retention-days: 7

  build-darwin-arm64:
    name: Build macOS ARM64
    runs-on: macos-latest
    needs: [bump-version]
    if: always() && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped') && github.event_name != 'pull_request' && !contains(github.event.head_commit.message, '[skip-ci]')
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Extract Go version from go.mod
        id: go-version
        run: echo "version=$(grep '^go ' go.mod | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ steps.go-version.outputs.version }}
          check-latest: true

      - name: Set up Go cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-arm64-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-arm64-go-

      - name: Get dependencies
        run: go mod download

      - name: Test
        run: make test

      - name: Build
        env:
          GOOS: darwin
          GOARCH: arm64
        run: |
          # Get version from tag, bump-version job, or use SHA for non-tag builds
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            # If this is a tag build, use the tag version
            VERSION=${GITHUB_REF#refs/tags/v}
          elif [[ "${{ github.ref }}" == "refs/heads/main" && "${{ needs.bump-version.outputs.new_tag }}" != "" ]]; then
            # If this is a main branch build with a new tag from bump-version job
            VERSION="${{ needs.bump-version.outputs.new_tag }}"
            VERSION=${VERSION#v}  # Remove the 'v' prefix
          else
            # For PR builds, use the commit SHA
            VERSION="sha-$(git rev-parse --short HEAD)"
          fi

          echo "Building version: $VERSION for darwin/arm64"

          # Get commit hash
          COMMIT=$(git rev-parse --short HEAD)

          # Get build date
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Create output directory
          mkdir -p bin

          # Build with ldflags to inject version info
          go build -v -o "bin/ccu-darwin-arm64" \
            -ldflags "-s -w -X main.Version=$VERSION -X main.Commit=$COMMIT -X main.BuildDate=$BUILD_DATE" \
            ./cmd/ccu

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ccu-darwin-arm64
          path: bin/ccu-darwin-arm64
          retention-days: 7

  build-darwin-amd64:
    name: Build macOS AMD64
    runs-on: macos-13
    needs: [bump-version]
    if: always() && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped') && github.event_name != 'pull_request' && !contains(github.event.head_commit.message, '[skip-ci]')
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Extract Go version from go.mod
        id: go-version
        run: echo "version=$(grep '^go ' go.mod | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ steps.go-version.outputs.version }}
          check-latest: true

      - name: Set up Go cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-amd64-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-amd64-go-

      - name: Get dependencies
        run: go mod download

      - name: Test
        run: make test

      - name: Build
        env:
          GOOS: darwin
          GOARCH: amd64
        run: |
          # Get version from tag, bump-version job, or use SHA for non-tag builds
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            # If this is a tag build, use the tag version
            VERSION=${GITHUB_REF#refs/tags/v}
          elif [[ "${{ github.ref }}" == "refs/heads/main" && "${{ needs.bump-version.outputs.new_tag }}" != "" ]]; then
            # If this is a main branch build with a new tag from bump-version job
            VERSION="${{ needs.bump-version.outputs.new_tag }}"
            VERSION=${VERSION#v}  # Remove the 'v' prefix
          else
            # For PR builds, use the commit SHA
            VERSION="sha-$(git rev-parse --short HEAD)"
          fi

          echo "Building version: $VERSION for darwin/amd64"

          # Get commit hash
          COMMIT=$(git rev-parse --short HEAD)

          # Get build date
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Create output directory
          mkdir -p bin

          # Build with ldflags to inject version info
          go build -v -o "bin/ccu-darwin-amd64" \
            -ldflags "-s -w -X main.Version=$VERSION -X main.Commit=$COMMIT -X main.BuildDate=$BUILD_DATE" \
            ./cmd/ccu

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ccu-darwin-amd64
          path: bin/ccu-darwin-amd64
          retention-days: 7

  release:
    name: Create Release
    needs: [build-linux-amd64, build-linux-arm64, build-darwin-arm64, build-darwin-amd64, bump-version]
    if: always() && !cancelled() && (needs.build-linux-amd64.result == 'success' && needs.build-linux-arm64.result == 'success' && needs.build-darwin-arm64.result == 'success' && needs.build-darwin-amd64.result == 'success') && (startsWith(github.ref, 'refs/tags/v') || (github.ref == 'refs/heads/main' && needs.bump-version.outputs.new_tag != '')) && !contains(github.event.head_commit.message, '[skip-ci]')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract Go version from go.mod
        id: go-version
        run: echo "version=$(grep '^go ' go.mod | awk '{print $2}')" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ steps.go-version.outputs.version }}
          check-latest: true

      - name: Download build artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts/
          pattern: ccu-*

      - name: Prepare release binaries
        run: |
          mkdir -p release/

          # Copy binaries for release (already properly named)
          cp artifacts/ccu-linux-amd64/ccu-linux-amd64 release/ccu-linux-amd64
          cp artifacts/ccu-linux-arm64/ccu-linux-arm64 release/ccu-linux-arm64
          cp artifacts/ccu-darwin-arm64/ccu-darwin-arm64 release/ccu-darwin-arm64
          cp artifacts/ccu-darwin-amd64/ccu-darwin-amd64 release/ccu-darwin-amd64

          # Make binaries executable
          chmod +x release/*

          # List what we have
          ls -la release/

      - name: Get version
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            # If this is a tag build, use the tag version
            VERSION=${GITHUB_REF#refs/tags/v}
          elif [[ "${{ github.ref }}" == "refs/heads/main" && "${{ needs.bump-version.outputs.new_tag }}" != "" ]]; then
            # If this is a main branch build with a new tag from bump-version job
            VERSION="${{ needs.bump-version.outputs.new_tag }}"
            VERSION=${VERSION#v}  # Remove the 'v' prefix
          else
            # Fallback (should not happen due to job condition)
            VERSION="0.0.0-unknown"
          fi

          echo "Using version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ needs.bump-version.outputs.changelog }}" != "" ]]; then
            # If this is a main branch build with a changelog from bump-version job
            CHANGELOG="${{ needs.bump-version.outputs.changelog }}"
          else
            # Generate changelog from git history
            # Get the latest tag before this one
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

            if [ -z "$PREVIOUS_TAG" ]; then
              # If there's no previous tag, get all commits
              CHANGELOG=$(git log --pretty=format:"* %s (%h)" --no-merges)
            else
              # Get commits between the previous tag and this one
              CHANGELOG=$(git log --pretty=format:"* %s (%h)" --no-merges ${PREVIOUS_TAG}..HEAD)
            fi
          fi

          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Prepare file list and platform docs
        id: file_list
        run: |
          FILES="release/ccu-linux-amd64
          release/ccu-linux-arm64
          release/ccu-darwin-arm64
          release/ccu-darwin-amd64"

          PLATFORMS="- **Linux AMD64**: \`ccu-linux-amd64\`
          - **Linux ARM64**: \`ccu-linux-arm64\`
          - **macOS Apple Silicon**: \`ccu-darwin-arm64\`
          - **macOS Intel**: \`ccu-darwin-amd64\`"

          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "platforms<<EOF" >> $GITHUB_OUTPUT
          echo "$PLATFORMS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.get_version.outputs.version }}
          body: |
            ## Changes in this Release

            ${{ env.CHANGELOG }}

            ## Installation

            #### Quick Install (Recommended)

            ```shell
            curl -fsSL https://raw.githubusercontent.com/sammcj/ccu/main/install.sh | bash
            ```

            #### Option 1: Install with `go install`

            ```shell
            go install github.com/sammcj/ccu/cmd/ccu@latest
            ```

            #### Option 2: Download pre-built binaries

            1. Download the binary for your platform:

            ${{ steps.file_list.outputs.platforms }}

            2. Rename the binary to `ccu` and place it in your path (e.g., `mv ccu-darwin-arm64 /usr/local/bin/ccu`).
            3. Make the binary executable: `chmod +x /usr/local/bin/ccu`

            On macOS, you may need to remove the quarantine attribute:
            ```shell
            xattr -r -d com.apple.quarantine /usr/local/bin/ccu
            ```

          files: ${{ steps.file_list.outputs.files }}
          draft: false
          prerelease: false
          tag_name: ${{ github.ref == 'refs/heads/main' && needs.bump-version.outputs.new_tag || github.ref }}

